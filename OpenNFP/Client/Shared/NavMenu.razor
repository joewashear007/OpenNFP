@using MudBlazor
@using System.IO
@using System.Text.Json
@inject IJSRuntime JS
@inject IChartingRepo Repo
@inject IDialogService DialogService
@inject ILocalStorageService localStorage
@inject NavigationManager MyNavigationManager

<MudStack Justify="@Justify.SpaceBetween" Style="height:100%">

    <MudNavMenu>
        <MudNavLink Href="@(MyNavigationManager.BaseUri)" Match="NavLinkMatch.All">Dashboard</MudNavLink>
        <MudNavLink Href="@(MyNavigationManager.BaseUri + "/editday/" + DateTime.Today.ToKey())" Match="NavLinkMatch.Prefix">Edit Day</MudNavLink>
        <MudNavGroup Title="Settings" Expanded="true">
            <MudNavLink OnClick="@ReloadDemoData">Reload Demo Data</MudNavLink>
            <MudNavLink OnClick="@Clear">Clear Data</MudNavLink>
        </MudNavGroup>
        <MudNavLink Href="/about" Match="NavLinkMatch.Prefix">About</MudNavLink>
    </MudNavMenu>

    <MudPaper>
        <MudList Clickable="true">
            <MudDivider />
            <MudListItem OnClick="Import" Text="Import" />
            <MudDivider />
            <MudListItem OnClick="Export" Text="Export" />
        </MudList>
    </MudPaper>
</MudStack>

<MudMessageBox @ref="mbox" Title="Replace Data" CancelText="Cancel" YesText="Upload and Overwrite">
    <MessageContent>
        This is erase all your data and import the data.
        <InputFile id="fileInput" OnChange="UploadFiles" hidden />
        <MudButton HtmlTag="label"
                   Variant="Variant.Filled"
                   Color="Color.Primary"
                   StartIcon="@Icons.Filled.CloudUpload"
                   for="fileInput">
            Upload Files
        </MudButton>
        @if (!string.IsNullOrEmpty(importErrorText))
        {
            <MudAlert Severity="Severity.Error">@importErrorText</MudAlert>
        }
    </MessageContent>
</MudMessageBox>


@code {

    private MudMessageBox mbox { get; set; }
    private ImportExportView? importData { get; set; } = null;
    private string importErrorText { get; set; } = "";

    private async Task Export()
    {
        var data = Repo.ExportModel;
        var bytes = JsonSerializer.SerializeToUtf8Bytes(data);
        await JS.InvokeVoidAsync("BlazorDownloadFile", "open-nfp.json", "application/json", bytes);
    }

    private async Task Import()
    {
        bool? result = await mbox.Show();
        if (result.HasValue && result.Value && importData != null)
        {
            await Repo.ImportAsync(importData);
            StateHasChanged();
            Console.WriteLine($"Successfully Import Data (Cycles: {Repo.Cycles.Count()} )");
            MyNavigationManager.NavigateTo(MyNavigationManager.BaseUri);
        }
    }


    private async Task UploadFiles(InputFileChangeEventArgs fileEvent)
    {
        try
        {
            Stream stream = fileEvent.File.OpenReadStream();
            importData = await JsonSerializer.DeserializeAsync<ImportExportView>(stream);
            importErrorText = "";
        }
        catch (Exception e)
        {
            importErrorText = e.Message;
        }
    }

    private async Task Clear()
    {
        await localStorage.ClearAsync();
        Repo.Clear();
    }

    private async Task ReloadDemoData()
    {
        await localStorage.ClearAsync();
        Repo.Clear();
        Repo.AddUpdateRecord(new DayRecord { Date = DateTime.Today.AddDays(-1), Temperature = 99.9M, ClearBlueResult = ClearBlueResult.Peak, CervixOpening = CervixOpening.Open });
        Repo.AddUpdateRecord(new DayRecord { Date = DateTime.Today.AddDays(-2), Temperature = 99.0M, ClearBlueResult = ClearBlueResult.Peak, CervixOpening = CervixOpening.Closed });
        Repo.AddUpdateRecord(new DayRecord { Date = DateTime.Today.AddDays(-3), Temperature = 98.4M, ClearBlueResult = ClearBlueResult.High, CervixOpening = CervixOpening.Closed });
        Repo.AddUpdateRecord(new DayRecord { Date = DateTime.Today.AddDays(-4), Temperature = 98.6M, ClearBlueResult = ClearBlueResult.High, CervixOpening = CervixOpening.Closed });
        Repo.AddUpdateRecord(new DayRecord { Date = DateTime.Today.AddDays(-5), Temperature = 98.9M, ClearBlueResult = ClearBlueResult.Low, CervixOpening = CervixOpening.Closed });
        Repo.AddUpdateRecord(new DayRecord { Date = DateTime.Today.AddDays(-6), Temperature = 98.7M, ClearBlueResult = ClearBlueResult.Low, Coitus = true, CervixOpening = CervixOpening.Closed });
        Repo.AddUpdateRecord(new DayRecord { Date = DateTime.Today.AddDays(-7), Temperature = 98.4M, ClearBlueResult = ClearBlueResult.Low, MenstruationFlow = MenstruationFlow.Spotting, CervixOpening = CervixOpening.Partial });
        Repo.AddUpdateRecord(new DayRecord { Date = DateTime.Today.AddDays(-8), Temperature = 98.3M, ClearBlueResult = ClearBlueResult.Unknown, MenstruationFlow = MenstruationFlow.Light, CervixOpening = CervixOpening.Partial });
        Repo.AddUpdateRecord(new DayRecord { Date = DateTime.Today.AddDays(-9), Temperature = 98.2M, ClearBlueResult = ClearBlueResult.Low, MenstruationFlow = MenstruationFlow.Heavy, CervixOpening = CervixOpening.Open });
        Repo.AddUpdateRecord(new DayRecord { Date = DateTime.Today.AddDays(-10), Temperature = 98.6M, ClearBlueResult = ClearBlueResult.Low, Coitus = true, MenstruationFlow = MenstruationFlow.Spotting, CervixOpening = CervixOpening.Closed });

    }
}