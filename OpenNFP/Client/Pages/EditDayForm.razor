@page "/editday/"
@page "/editday/{date}"

@inject IChartingRepo ChartingRepo
@inject ILocalStorageService localStorage
@inject NavigationManager uriHelper;

<PageTitle>Edit Page: @date (Cycle Day: #)</PageTitle>

<MudContainer Class="mt-16" MaxWidth="MaxWidth.Medium">
    @if (Day != null)
    {
        <MudCard>
            <MudForm @ref="form" @bind-IsValid="@success" @bind-Errors="@errors">
                <MudCardContent>
                    <MudGrid>
                        <MudItem md="4">
                            <MudDatePicker Label="Date" Date="@dateVal" DateChanged="@(d => ChangeDate(d))"></MudDatePicker>
                        </MudItem>
                        <MudItem md="4">
                            <MudNumericField @bind-Value="@Day.Temperature"
                                         Label="Temperature"
                                         Step=".1M"
                                         Adornment="Adornment.End" AdornmentText="°F" Clearable=true />
                        </MudItem>
                        <MudItem m3="4">
                            <MudCheckBox Class="mt-2" Label="Coitus" @bind-Checked="@Day.Coitus" Color="Color.Secondary" CheckedIcon="@Icons.Material.Filled.Favorite" UncheckedIcon="@Icons.Material.Filled.FavoriteBorder"></MudCheckBox>
                        </MudItem>
                    </MudGrid>
                    <MudGrid>
                        <MudItem md="6">
                            <MudField Label="Ovulation Test" Class="mb-4">
                                <MudRadioGroup @bind-SelectedOption="@ovulationTest.ValueInt">
                                    @foreach (var v in Enum.GetValues<TestResult>())
                                    {
                                    <MudRadio Option="@((int)v)">@v.ToString()</MudRadio>
                                    }
                            </MudRadioGroup>
                        </MudField>
                    </MudItem>
                    <MudItem md="6">
                        <MudField Label="Pregancy Test">
                            <MudRadioGroup @bind-SelectedOption="@pregTest.ValueInt">
                                @foreach (var v in Enum.GetValues<TestResult>())
                                    {
                                    <MudRadio Option="@((int)v)">@v.ToString()</MudRadio>
                                    }
                            </MudRadioGroup>
                        </MudField>
                    </MudItem>
                </MudGrid>
            </MudCardContent>

            <MudCardContent Class="pa-0">
                <MudSlider TickMarks="true" TickMarkLabels="@clearblue.Labels"
                           Step="1"
                           Min="@clearblue.Min"
                           Max="@clearblue.Max"
                           @bind-Value="@clearblue.ValueInt"
                           Class="mb-4 pl-8 pr-8">ClearBlue Monitor Value</MudSlider>

                <MudSlider TickMarks="true" TickMarkLabels="@cervixTexture.Labels"
                           Step="1"
                           Min="@cervixTexture.Min"
                           Max="@cervixTexture.Max"
                           @bind-Value="@cervixTexture.ValueInt"
                           Class="mb-4 pl-8 pr-8">Cervix Firmness</MudSlider>

                <MudSlider TickMarks="true" TickMarkLabels="@cervixOpening.Labels"
                           Step="1"
                           Min="@cervixOpening.Min"
                           Max="@cervixOpening.Max"
                           @bind-Value="@cervixOpening.ValueInt"
                           Class="mb-4 pl-8 pr-8">Cervix Openness</MudSlider>

                <MudSlider TickMarks="true" TickMarkLabels="@mucusCharacteristic.Labels"
                           Step="1"
                           Min="@mucusCharacteristic.Min"
                           Max="@mucusCharacteristic.Max"
                           @bind-Value="@mucusCharacteristic.ValueInt"
                           Class="mb-4 pl-8 pr-8">Mucus Characteristic</MudSlider>

                <MudSlider TickMarks="true" TickMarkLabels="@mucusSensation.Labels"
                           Step="1"
                           Min="@mucusSensation.Min"
                           Max="@mucusSensation.Max"
                           @bind-Value="@mucusSensation.ValueInt"
                           Class="mb-4 pl-8 pr-8">Mucus Sensation</MudSlider>

                <MudSlider TickMarks="true" TickMarkLabels="@menstruationFlow.Labels"
                           Step="1"
                           Min="@menstruationFlow.Min"
                           Max="@menstruationFlow.Max"
                           @bind-Value="@menstruationFlow.ValueInt"
                           Class="mb-4 pl-8 pr-8">Menstration</MudSlider>

            </MudCardContent>

            <MudCardContent Class=" mt-8">
                <MudTextField Label="Notes" @bind-Value="@Day.Notes" Lines="5" Variant="Variant.Outlined" />
            </MudCardContent>
            <MudCardActions>
                <MudCheckBox @bind-Checked="@startCycle" Label="This Day Should Start a Cycle"></MudCheckBox>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" OnClick="@(() => Save())">Save</MudButton>
            </MudCardActions>
        </MudForm>
    </MudCard>
    }
    else
    {
        <MudSkeleton SkeletonType="SkeletonType.Rectangle" />
    }
</MudContainer>

@code {
    [Parameter]
    public string date { get; set; } = string.Empty;

    DateTime? dateVal { get; set; }
    DayRecord? Day { get; set; } = null;
    bool success;
    string[] errors = { };

    private bool startCycle { get; set; } = false;

    MudForm form;

    class EnumSliderHelper<T> where T : struct, Enum
    {
        public EnumSliderHelper(Action<T> setProp)
        {
            this.setProp = setProp;
        }
        private T _value = default(T);
        private readonly Action<T> setProp;

        public string[] Labels => Enum.GetNames<T>();
        public int Min => Enum.GetValues<T>().Cast<int>().Min();
        public int Max => Enum.GetValues<T>().Cast<int>().Max();
        public int ValueInt
        {
            get => (int)(object)_value;
            set
            {
                T newValue = (T)(object)value;
                _value = newValue;
                setProp(newValue);
            }
        }
        public T Value
        {
            get => _value;
            set
            {
                _value = value;
                setProp(value);
            }
        }
    }

    EnumSliderHelper<ClearBlueResult>? clearblue = null;
    EnumSliderHelper<CervixOpening>? cervixOpening = null;
    EnumSliderHelper<CervixTexture>? cervixTexture = null;
    EnumSliderHelper<MenstruationFlow>? flow = null;
    EnumSliderHelper<TestResult>? pregTest = null;
    EnumSliderHelper<TestResult>? ovulationTest = null;
    EnumSliderHelper<MucusSensation>? mucusSensation = null;
    EnumSliderHelper<MucusCharacteristic>? mucusCharacteristic = null;
    EnumSliderHelper<MenstruationFlow>? menstruationFlow = null;

    protected override async Task OnInitializedAsync()
    {
        clearblue = new EnumSliderHelper<ClearBlueResult>(q => Day.ClearBlueResult = q);
        cervixOpening = new EnumSliderHelper<CervixOpening>(q => Day.CervixOpening = q);
        cervixTexture = new EnumSliderHelper<CervixTexture>(q => Day.CervixTexture = q);
        flow = new EnumSliderHelper<MenstruationFlow>(q => Day.MenstruationFlow = q);
        pregTest = new EnumSliderHelper<TestResult>(q => Day.PregnancyTest = q);
        ovulationTest = new EnumSliderHelper<TestResult>(q => Day.OvulationTest = q);
        mucusSensation = new EnumSliderHelper<MucusSensation>(q => Day.MucusSensation = q);
        mucusCharacteristic = new EnumSliderHelper<MucusCharacteristic>(q => Day.MucusCharacteristic = q);
        menstruationFlow = new EnumSliderHelper<MenstruationFlow>(q => Day.MenstruationFlow = q);

        if (string.IsNullOrEmpty(date))
        {
            date = DateTime.Today.ToKey();
            dateVal = DateTime.Today;
            Day = new DayRecord() { Date = dateVal.Value };
            startCycle = false;
        }
        else
        {
            dateVal = date.ToDateTime();
            Day = await ChartingRepo.GetDayAsync(date);
            startCycle = ChartingRepo.GetCycleDay(date) == 1;
        }

        clearblue.Value = Day.ClearBlueResult;
        clearblue.Value = Day.ClearBlueResult;
        cervixOpening.Value = Day.CervixOpening;
        cervixTexture.Value = Day.CervixTexture;
        flow.Value = Day.MenstruationFlow;
        pregTest.Value = Day.PregnancyTest;
        ovulationTest.Value = Day.OvulationTest;
        mucusSensation.Value = Day.MucusSensation;
        mucusCharacteristic.Value = Day.MucusCharacteristic;
        menstruationFlow.Value = Day.MenstruationFlow;
    }

    private async Task Save()
    {
        if (Day != null)
        {
            Day.ClearBlueResult = clearblue.Value;
            Day.ClearBlueResult = clearblue.Value;
            Day.CervixOpening = cervixOpening.Value;
            Day.CervixTexture = cervixTexture.Value;
            Day.MenstruationFlow = flow.Value;
            Day.PregnancyTest = pregTest.Value;
            Day.OvulationTest = ovulationTest.Value;
            Day.MucusSensation = mucusSensation.Value;
            Day.MucusCharacteristic = mucusCharacteristic.Value;
            Day.MenstruationFlow = menstruationFlow.Value;
            await form.Validate();
            if (form.IsValid)
            {
                bool isAlreadyCycleStart = ChartingRepo.IsCycleStart(Day.IndexKey);
                Console.WriteLine($"Saving Day {Day.Date} - State Cycle: {startCycle}");
                if(!startCycle && isAlreadyCycleStart)
                {
                    await ChartingRepo.DeleteCycleAsync(Day.IndexKey);
                }
                await ChartingRepo.AddUpdateRecord(Day, startCycle);
                uriHelper.NavigateTo(uriHelper.BaseUri);
                await localStorage.SetItemAsync(Day.IndexKey, Day);
                await localStorage.SetItemAsync("chart.settings", ChartingRepo.GetSettings());
            }
        }
        else
        {
            Console.WriteLine("Error - Day is null");
        }
    }

    private async Task ChangeDate(DateTime? d)
    {
        Console.WriteLine($"Changeing Date: {d}");
        dateVal = d;
        date = dateVal.ToKey();
        Day = await ChartingRepo.GetDayAsync(date);
        if (Day == null)
        {
            Day = new DayRecord() { Date = dateVal.Value };
        }
        clearblue.Value = Day.ClearBlueResult;
        clearblue.Value = Day.ClearBlueResult;
        cervixOpening.Value = Day.CervixOpening;
        cervixTexture.Value = Day.CervixTexture;
        flow.Value = Day.MenstruationFlow;
        pregTest.Value = Day.PregnancyTest;
        ovulationTest.Value = Day.OvulationTest;
        mucusSensation.Value = Day.MucusSensation;
        mucusCharacteristic.Value = Day.MucusCharacteristic;
        menstruationFlow.Value = Day.MenstruationFlow;
        startCycle = ChartingRepo.GetCycleDay(date) == 1;
        StateHasChanged();
    }
}